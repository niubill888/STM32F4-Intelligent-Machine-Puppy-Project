## 项目概述
本项目基于STM32F407IGT6微控制器，集成了多种外设和通信模块，实现了通过WiFi、语音等方式控制硬件设备（LED、蜂鸣器、风扇、舵机等），并能采集温湿度数据进行显示。系统采用FreeRTOS实时操作系统进行任务管理，确保各功能模块高效协同工作。


## 硬件组成
1. **主控芯片**：STM32F407IGT6（高性能ARM Cortex-M4内核，1MB Flash，192KB RAM）
2. **通信模块**：
   - ESP12F WiFi模块（通过USART2通信，支持WiFi连接和TCP通信）
   - ASRPro语音识别模块（通过USART2发送控制指令）
3. **传感器**：
   - SHT20温湿度传感器（通过IIC总线通信）
4. **输出设备**：
   - LED指示灯（含流水灯功能）
   - 蜂鸣器（报警提示）
   - 风扇（散热控制）
   - SG90舵机（多自由度动作控制，如站立、前进、后退等）
   - 4位数码管（通过74HC595芯片驱动，显示温湿度数据）
5. **其他外设**：
   - SPI2接口（驱动74HC595）
   - TIM3定时器（生成PWM信号，控制舵机）
   - 多个USART接口（分别用于ESP12F、语音模块等通信）


## 软件架构
1. **操作系统**：FreeRTOS（任务调度、信号量、队列等同步机制）
2. **核心任务**（按优先级从高到低）：
   - `vInitTask`：系统初始化任务（最高优先级5），完成外设初始化、FreeRTOS对象创建及其他任务启动，初始化完成后自动删除。
   - `vSegScanTask`：数码管动态扫描任务（优先级5），循环刷新4位数码管显示，周期5ms。
   - `vServoTask`：舵机控制任务（优先级4），处理舵机指令队列，执行站立、前进等动作。
   - `esp_process_task`：ESP12F响应处理任务（优先级3），解析WiFi模块的串口响应数据。
   - `vASRProTask`：语音指令处理任务（优先级3），接收语音指令并分发到对应硬件控制逻辑。
   - `vDataUpdateTask`：数据更新任务（优先级2），定时采集SHT20温湿度数据并更新数码管显示，周期500ms。
3. **驱动模块**：
   - 外设驱动：`drv_led`、`drv_beep`、`drv_fan`、`drv_motor`等（控制对应硬件）
   - 通信驱动：`drv_usart`（串口）、`drv_iic`（IIC总线）、`drv_spi2`（SPI总线）
   - 传感器驱动：`drv_sht20`（温湿度采集）
   - 显示驱动：`74hc595`（数码管控制）
   - 舵机驱动：`drv_sg90`（舵机动作控制）


## 功能说明
1. **WiFi通信功能**：
   - ESP12F模块通过AT指令初始化，连接指定WiFi
   - 建立TCP连接
   - 接收TCP服务器命令（格式：`设备_操作`，如`fan_open`控制风扇开启）
2. **温湿度采集与显示**：
   - SHT20传感器定时采集温度（范围-40~125℃）和湿度（范围0~100%RH）
   - 4位数码管显示温湿度数据，通过按键（key1）切换显示模式
3. **外设控制**：
   - 支持通过TCP命令、语音指令控制LED、蜂鸣器、风扇、电机的开关
   - 舵机支持多种动作：站立、坐下、前进、后退、鞠躬、抬头（通过语音或TCP指令触发）
4. **语音交互**：
   - ASRPro语音模块接收指令，通过串口发送控制码（如0x01开灯、0x03控制舵机站立）


## 使用方法
1. **硬件连接**：确保各外设按驱动定义的引脚正确连接
2. **环境配置**：
   - 修改ESP12F驱动中的WiFi信息（`cmds`数组中的`AT+CWJAP_DEF`指令）和TCP服务器地址（`AT+CIPSTART`指令），适配实际网络环境。
3. **编译与下载**：使用Keil MDK编译项目，通过J-Link或ST-Link下载到STM32F407IGT6开发板。
4. **操作流程**：
   - 系统上电后自动初始化，ESP12F会依次执行复位、连接WiFi、连接TCP服务器等操作。
   - 数码管默认显示温度数据。
   - 通过TCP服务器或语音发送命令（如`led_open`）或语音指令（如“开灯”）控制外设。


## 注意事项
1. ESP12F初始化过程中若超时或失败，系统会进入错误状态，可通过重启恢复。
2. 舵机动作执行过程中，新的舵机指令会打断当前动作，优先执行新指令。
3. SHT20传感器采集需要约120ms转换时间，请勿频繁触发采集。
4. 确保电源供电稳定，舵机工作时电流较大，建议使用外部电源供电。